<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FinSight – NL Financial Query</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 32px auto 48px;
      padding: 0 24px 48px;
    }

    /* Top FinSight pill */
    .title-pill {
      width: 100%;
      border-radius: 9999px;
      background: #020617;
      border: 1px solid #111827;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
      padding: 18px 32px;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .title-pill h1 {
      margin: 0;
      font-size: 32px;
      letter-spacing: 0.04em;
      font-weight: 700;
      color: #f9fafb;
      text-align: center;
    }

    .muted {
      color: #9ca3af;
    }

    .card {
      background: #020617;
      border-radius: 24px;
      border: 1px solid #111827;
      padding: 24px 24px 20px;
      margin-top: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.85);
    }

    .card + .card {
      margin-top: 20px;
    }

    label {
      font-weight: 700;
      font-size: 18px;
      display: block;
      margin-bottom: 12px;
      color: #f9fafb;
    }

    textarea {
      width: 100%;
      min-height: 110px;
      padding: 14px 16px;
      border-radius: 18px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 15px;
      resize: vertical;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.7);
    }

    textarea::placeholder {
      color: #6b7280;
    }

    textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    button {
      padding: 12px 28px;
      border-radius: 9999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      color: #0b1020;
      cursor: pointer;
      background-image: linear-gradient(90deg, #38bdf8, #6366f1, #a855f7);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.96;
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.65;
      box-shadow: none;
    }

    .error {
      color: #f87171;
      margin-top: 10px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }

    th,
    td {
      padding: 10px 8px;
      border-bottom: 1px solid #111827;
      text-align: left;
    }

    th {
      background: #020617;
      color: #9ca3af;
      font-weight: 600;
      border-bottom: 1px solid #1f2937;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.5);
    }

    tbody tr:hover {
      background: rgba(31, 41, 55, 0.7);
    }

    .results-meta {
      font-size: 13px;
      margin-bottom: 8px;
    }

    .row-actions {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & Babel (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState } = React;

    function App() {
      const [nlQuery, setNlQuery] = useState("");
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState("");
      const [data, setData] = useState(null);

      const runQuery = async () => {
        if (!nlQuery.trim()) {
          setError("Please enter a query.");
          return;
        }
        setError("");
        setLoading(true);
        setData(null);
        try {
          const res = await fetch("/api/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nl_query: nlQuery }),
          });
          const text = await res.text();
          const json = text ? JSON.parse(text) : {};
          if (!res.ok) {
            throw new Error(json.error || `HTTP ${res.status}`);
          }
          setData(json);
        } catch (e) {
          setError(e.message || "Request failed");
        } finally {
          setLoading(false);
        }
      };

      const results = data?.results || [];
      const plan = data?.plan || null;

      return (
        <div className="page">
          <div className="title-pill">
            <h1>FinSight</h1>
          </div>

          <div className="card">
            <label>Get Financial Insight</label>
            <textarea
              placeholder="Show companies with 20% price growth in 2017 and ROE &gt; 15"
              value={nlQuery}
              onChange={(e) => setNlQuery(e.target.value)}
              disabled={loading}
            />
            <div className="row-actions">
              <button onClick={runQuery} disabled={loading}>
                {loading ? "Running..." : "Run Query"}
              </button>
              {loading && <span className="muted">Running query...</span>}
            </div>
            {error && <div className="error">{error}</div>}
          </div>

          {data?.llm_summary && (
            <div className="card">
              <div style={{ fontWeight: 700, marginBottom: 6 }}>LLM Summary</div>
              <div>{data.llm_summary}</div>
            </div>
          )}

          <div className="card">
            <div style={{ fontWeight: 700, marginBottom: 6 }}>Results</div>
            {plan && (
              <div className="muted results-meta">
                Date range: {plan.start_date} to {plan.end_date}
                {plan.symbols ? ` | Symbols: ${plan.symbols.join(", ")}` : ""}
                {plan.fy ? ` | FY: ${plan.fy}` : ""}
              </div>
            )}
            {!results.length ? (
              <div className="muted">No companies matched your criteria.</div>
            ) : (
              <table>
                <thead>
                  <tr>
                    <th>Symbol</th>
                    <th>Start Price</th>
                    <th>End Price</th>
                    <th>% Growth</th>
                    <th>ROE</th>
                    <th>Debt/Equity</th>
                    <th>P/E</th>
                    <th>Current Ratio</th>
                    <th>Market Cap</th>
                  </tr>
                </thead>
                <tbody>
                  {results.map((r) => (
                    <tr key={r.symbol}>
                      <td>{r.symbol}</td>
                      <td>{fmtNum(r.start_price)}</td>
                      <td>{fmtNum(r.end_price)}</td>
                      <td>{fmtPct(r.price_growth)}</td>
                      <td>{fmtNum(r.roe)}</td>
                      <td>{fmtNum(r.debt_equity_ratio)}</td>
                      <td>{fmtNum(r.pe_ratio)}</td>
                      <td>{fmtNum(r.current_ratio)}</td>
                      <td>{fmtCap(r.market_cap)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        </div>
      );
    }

    const fmtNum = (v) =>
      v !== null && v !== undefined && Math.abs(Number(v)) > 0
        ? Number(v).toFixed(2)
        : "-";

    const fmtPct = (v) =>
      v !== null && v !== undefined && Math.abs(Number(v)) > 0
        ? (Number(v) * 100).toFixed(2) + "%"
        : "-";

    const fmtCap = (v) =>
      v !== null && v !== undefined && Math.abs(Number(v)) > 0
        ? "Rs " + Number(v).toLocaleString("en-IN")
        : "-";

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
